(function(g){function E(j,s){for(var z=s>3?5:1E3,c,f=[j[0],j[1]],k,m=[j[0],j[1]],r=2,F=j.length-3;r<F;r+=2){c=[j[r],j[r+1]];k=[j[r+2]||j[0],j[r+3]||j[1]];var G=f,w=G[0],x=G[1],A=k[0]-w,T=k[1]-x,K=void 0;if(A!==0||T!==0){K=((c[0]-w)*A+(c[1]-x)*T)/(A*A+T*T);if(K>1){w=k[0];x=k[1]}else if(K>0){w+=A*K;x+=T*K}}w=pa(c,[w,x])*2;k=pa(G,k);if(w*k>z){m.push(c[0],c[1]);f=c}}if(c[0]!==j[0]||c[1]!==j[1])m.push(j[0],j[1]);console.log(j.length,m.length,s,z);return m}function pa(j,s){var z=j[0]-s[0],c=j[1]-s[1];return z*
z+c*c}function Ea(j){for(var s=0,z=0,c=0,f=j.length-3;c<f;c+=2){s+=j[c];z+=j[c+1]}j=(j.length-2)*2;return[s/j<<0,z/j<<0]}var Fa=Fa||Array,Ja=Math.exp,Ka=Math.log,La=Math.tan,Ma=Math.atan,va=Math.min,Na=Math.max,wa=g.document,M=function(){function j(c,f,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return c+(f-c)*6*k;if(k<0.5)return f;if(k<2/3)return c+(f-c)*(2/3-k)*6;return c}function s(c,f,k,m){this.r=c;this.g=f;this.b=k;this.a=arguments.length<4?1:m}var z=s.prototype;z.toString=function(){return"rgba("+[this.r<<
0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};z.adjustLightness=function(c){var f=M.toHSLA(this);f.l*=c;f.l=Math.min(1,Math.max(0,f.l));var k,m;if(f.s===0)c=k=m=f.l;else{m=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var r=2*f.l-m;c=j(r,m,f.h+1/3);k=j(r,m,f.h);m=j(r,m,f.h-1/3)}return new M(c*255<<0,k*255<<0,m*255<<0,f.a)};z.adjustAlpha=function(c){return new M(this.r,this.g,this.b,this.a*c)};s.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new M(parseInt(c[1],
16),parseInt(c[2],16),parseInt(c[3],16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new M(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};s.toHSLA=function(c){var f=c.r/255,k=c.g/255,m=c.b/255,r=Math.max(f,k,m),F=Math.min(f,k,m),G,w=(r+F)/2,x;if(r===F)G=F=0;else{x=r-F;F=w>0.5?x/(2-r-F):x/(r+F);switch(r){case f:G=(k-m)/x+(k<m?6:0);break;case k:G=(m-f)/x+2;break;case m:G=(f-k)/x+4;break}G/=6}return{h:G,s:F,l:w,
a:c.a}};return s}(),da=Math.PI,Ga=da/2,Oa=da/4,Pa=180/da,Qa=256,xa=14,ea=400,Ha=ea-50,fa="latitude",ga="longitude",I=0,U=1,N=2,V=3,qa=4,ha=5,R=6;g.OSMBuildings=function(j){function s(a,e){var b={};a/=ia;e/=ia;b[fa]=e<=0?90:e>=1?-90:Pa*(2*Ma(Ja(da*(1-2*e)))-Ga);b[ga]=(a===1?1:(a%1+1)%1)*360-180;return b}function z(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||
b.status>299||b.responseText&&e(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function f(){if(!(!ya||J<xa)){var a=s(aa-ja,ba-za),e=s(aa+Z+ja,ba+S+za);ra&&ra.abort();ra=c(z(ya,{w:a[ga],n:a[fa],e:e[ga],s:e[fa],z:J}),k)}}function k(a){var e,b,d,i=[],h,l=h=0;ka=xa;w(J);ra=null;if(!(!a||a.meta.z!==J)){d=a.meta;b=a.data;if(B&&v&&B.z===d.z){h=B.x-d.x;l=B.y-d.y;a=0;for(e=v.length;a<e;a++)i[a]=v[a][N][0]+h+","+(v[a][N][1]+l)}B=d;v=[];a=0;for(e=b.length;a<e;a++){d=[];h=E(b[a][N],b[a][I]);
if(!(h.length<8)){d[N]=h;d[qa]=Ea(h);d[I]=va(b[a][I],Ha);d[U]=b[a][U];h=d[N][0]+","+d[N][1];d[ha]=!(i&&~i.indexOf(h));d[V]=[];d[R]=[];v.push(d)}}x()}}function m(a,e){var b=[],d,i,h,l,n,o,p,t,W=Aa-J;d=0;for(i=a.length;d<i;d++){n=a[d];o=n[N];t=new Fa(o.length);h=0;for(l=o.length-1;h<l;h+=2){p=o[h+1];var H=va(1,Na(0,0.5-Ka(La(Oa+Ga*o[h]/180))/da/2));p={x:(p/360+0.5)*ia<<0,y:H*ia<<0};t[h]=p.x;t[h+1]=p.y}t=E(t,n[I]);if(!(t.length<8)){l=[];l[N]=t;l[qa]=Ea(t);l[I]=va(n[I]>>W,Ha);l[U]=n[U];l[ha]=e;l[V]=n[V];
l[R]=[];for(h=0;h<3;h++)if(l[V][h])l[R][h]=l[V][h].adjustAlpha(O)+"";b.push(l)}}return b}function r(a,e){if(typeof a==="object")G(a,!e);else{var b=wa.documentElement,d=wa.createElement("script");g.jsonpCallback=function(i){delete g.jsonpCallback;b.removeChild(d);G(i,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function F(a,e,b){if(b===undefined)b=[];var d,i,h,l=a[0]?a:a.features,n,o,p,t,W,H=e?1:0,X=e?0:1;if(l){d=0;for(a=l.length;d<a;d++)F(l[d],e,b);return b}if(a.type===
"Feature"){n=a.geometry;d=a.properties}if(n.type==="Polygon")o=[n.coordinates];if(n.type==="MultiPolygon")o=n.coordinates;if(o){e=d.height;if(d.color||d.wallColor)t=M.parse(d.color||d.wallColor);if(d.roofColor)W=M.parse(d.roofColor);d=0;for(a=o.length;d<a;d++){l=o[d][0];p=[];i=n=0;for(h=l.length;i<h;i++){p.push(l[i][H],l[i][X]);n+=e||l[i][2]||0}if(n){i=[];h=N;var u=void 0,q=void 0,C=void 0,P=void 0,la=0,Q=void 0,Ia=void 0;Q=0;for(Ia=p.length-3;Q<Ia;Q+=2){u=p[Q];q=p[Q+1];C=p[Q+2];P=p[Q+3];la+=u*P-
C*q}if((la/2>0?"CW":"CCW")==="CW")p=p;else{u=[];for(q=p.length-2;q>=0;q-=2)u.push(p[q],p[q+1]);p=u}i[h]=p;i[I]=n/l.length<<0;i[V]=[t||null,t?t.adjustLightness(0.8):null,W?W:t?t.adjustLightness(1.2):$];b.push(i)}}}return b}function G(a,e){if(a){ma=F(a,e);ka=0;w(J);B={n:90,w:-180,s:-90,e:180,x:0,y:0,z:J};v=m(ma,true);x()}else{ma=null;A()}}function w(a){var e,b,d;J=a;ia=Qa<<J;O=1-(J-ka)*0.3/(Aa-ka);Ba=Y.adjustAlpha(O)+"";sa=ta.adjustAlpha(O)+"";ua=$.adjustAlpha(O)+"";if(v){a=0;for(e=v.length;a<e;a++){d=
v[a];d[R]=[];for(b=0;b<3;b++)if(d[V][b])d[R][b]=d[V][b].adjustAlpha(O)+""}}}function x(){ca=0;clearInterval(Ca);Ca=setInterval(function(){ca+=0.1;if(ca>1){clearInterval(Ca);ca=1;for(var a=0,e=v.length;a<e;a++)v[a][ha]=0}A()},33)}function A(){y.clearRect(0,0,Z,S);if(B&&v)if(!(J<ka||Da)){var a,e,b,d,i,h,l,n,o,p=aa-B.x,t=ba-B.y,W=[na+p,oa+t],H,X,u,q,C,P;v.sort(function(la,Q){return pa(Q[qa],W)/Q[I]-pa(la[qa],W)/la[I]});a=0;for(e=v.length;a<e;a++){i=v[a];u=false;h=i[N];H=[];b=0;for(d=h.length-1;b<d;b+=
2){H[b]=n=h[b]-p;H[b+1]=o=h[b+1]-t;u||(u=n>0&&n<Z&&o>0&&o<S)}if(u){b=i[ha]?i[I]*ca:i[I];h=ea/(ea-b);if(i[U]){b=i[ha]?i[U]*ca:i[U];l=ea/(ea-b)}n=[];X=[];b=0;for(d=H.length-3;b<d;b+=2){o=H[b];q=H[b+1];u=H[b+2];C=H[b+3];P=K(o,q,h);X=K(u,C,h);if(i[U]){q=K(o,q,l);C=K(u,C,l);o=q.x;q=q.y;u=C.x;C=C.y}if((u-o)*(P.y-q)>(P.x-o)*(C-q)){X=[u+0.5,C+0.5,o+0.5,q+0.5,P.x,P.y,X.x,X.y];y.fillStyle=o<u&&q<C||o>u&&q>C?i[R][1]||sa:i[R][0]||Ba;T(X)}n[b]=P.x;n[b+1]=P.y}y.fillStyle=i[R][2]||ua;y.strokeStyle=i[R][1]||sa;T(n,
true)}}}}function T(a,e){if(a.length){y.beginPath();y.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)y.lineTo(a[b],a[b+1]);y.closePath();e&&y.stroke();y.fill()}}function K(a,e,b){return{x:((a-na)*b+na<<0)+0.5,y:((e-oa)*b+oa<<0)+0.5}}var Z=0,S=0,ja=0,za=0,aa=0,ba=0,J,ia,ra,D,y,ya,Y=new M(200,190,180),ta=Y.adjustLightness(0.8),$=Y.adjustLightness(1.2),Ba=Y+"",sa=ta+"",ua=$+"",ma,B,v,ca=1,Ca,O=1,ka=xa,Aa=20,na,oa,Da;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){Y=M.parse(a.color||
a.wallColor);Ba=Y.adjustAlpha(O)+"";ta=Y.adjustLightness(0.8);sa=ta.adjustAlpha(O)+"";$=Y.adjustLightness(1.2);ua=$.adjustAlpha(O)+""}if(a.roofColor){$=M.parse(a.roofColor);ua=$.adjustAlpha(O)+""}A();return this};this.geoJSON=function(a,e){r(a,e);return this};this.setCamOffset=function(a,e){na=ja+a;oa=S+e};this.setMaxZoom=function(a){Aa=a};this.createCanvas=function(a){D=wa.createElement("canvas");D.style.webkitTransform="translate3d(0,0,0)";D.style.imageRendering="optimizeSpeed";D.style.position=
"absolute";D.style.pointerEvents="none";D.style.left=0;D.style.top=0;a.appendChild(D);y=D.getContext("2d");y.lineCap="round";y.lineJoin="round";y.lineWidth=1;try{y.mozImageSmoothingEnabled=false}catch(e){}return D};this.destroyCanvas=function(){D.parentNode.removeChild(D)};this.loadData=f;this.onMoveEnd=function(){var a=s(aa,ba),e=s(aa+Z,ba+S);A();if(B&&(a[fa]>B.n||a[ga]<B.w||e[fa]<B.s||e[ga]>B.e))f()};this.onZoomEnd=function(a){Da=false;w(a.zoom);if(ma){v=m(ma);A()}else{A();f()}};this.onZoomStart=
function(){Da=true;A()};this.render=A;this.setOrigin=function(a,e){aa=a;ba=e};this.setSize=function(a,e){Z=a;S=e;ja=Z/2<<0;za=S/2<<0;na=ja;oa=S;D.width=Z;D.height=S};this.setZoom=w;ya=j};g.OSMBuildings.VERSION="0.1.7a";g.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(g){L.Util.setOptions(this,g)},onMove:function(){var g=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-g.x,this.lastY-g.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var g=L.DomUtil.getPosition(this.map._mapPane),E=this.map.getPixelOrigin();this.lastX=g.x;this.lastY=g.y;this.canvas.style.left=-g.x+"px";
this.canvas.style.top=-g.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(E.x-g.x,E.y-g.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var g=L.DomUtil.getPosition(this.map._mapPane),E=this.map.getPixelOrigin();this.osmb.setOrigin(E.x-g.x,E.y-g.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(g){g.addLayer(this);return this},onAdd:function(g){this.map=g;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;g=L.DomUtil.getPosition(this.map._mapPane);var E=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(E.x-g.x,E.y-g.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-g.x+"px";this.canvas.style.top=-g.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(g){g.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);g.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(g,E){return this.osmb.geoJSON(g,E)},
setStyle:function(g){return this.osmb.setStyle(g)}});
